name: Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Tests
        run: python manage.py test

  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate Image Tag
        id: tag
        run: |
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]' | sed 's:.*/::')
          SHORT_SHA=${GITHUB_SHA:0:7}
          echo "image_tag=${{ secrets.DOCKERHUB_USERNAME }}/$IMAGE_NAME:${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.tag.outputs.image_tag }}
          platforms: linux/amd64,linux/arm64/v8

      - name: Encode docker-compose.yml
        id: compose
        run: |
          COMPOSE_FILE="docker-compose.yml"
          if [ ! -f "$COMPOSE_FILE" ]; then
            echo "Error: $COMPOSE_FILE not found!"
            exit 1
          fi
          COMPOSE_B64=$(base64 -w 0 "$COMPOSE_FILE")
          echo "b64=$COMPOSE_B64" >> $GITHUB_OUTPUT

      - name: Collect All Repository Secrets Dynamically
        run: |
          # Create JSON with all repo secrets (name = value)
          SECRETS_JSON=$(jq -n 'env | with_entries(select(.key | startswith("")))')
          
          # Add DOCKER_IMAGE_TAG (not a secret)
          FINAL_JSON=$(echo "$SECRETS_JSON" | jq --arg tag "${{ steps.tag.outputs.image_tag }}" '. + {DOCKER_IMAGE_TAG: $tag}')
          
          # Compact for payload
          ENCODED=$(echo "$FINAL_JSON" | jq -c .)
          echo "secrets_json=$ENCODED" >> $GITHUB_ENV

      - name: Trigger Deployment in Infra Repo
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.INFRA_PAT }}
          repository: stevendegwa/infra
          event-type: deploy-app
          client-payload: |
            {
              "app_repo": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "env": "prod",
              "sha": "${{ github.sha }}",
              "image_tag": "${{ steps.tag.outputs.image_tag }}",
              "docker_compose_b64": "${{ steps.compose.outputs.b64 }}",
              "env_secrets": ${{ env.secrets_json }}
            }
